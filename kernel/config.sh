#!/usr/bin/env bash
# vim: tabstop=4 shiftwidth=4 expandtab colorcolumn=80 foldmethod=marker :

declare -A syms
syms[kmem_cache_create_usercopy]='slab.h'
syms[file_inode]='fs.h'
syms[sysfs_emit]='sysfs.h'

output='config.h'
uname_r="$( uname -r )"
if [ -e "/lib/modules/${uname_r}/build/include/linux/fs.h" ]
then
    KDIR="/lib/modules/${uname_r}/build"
elif [ -e "/lib/modules/${uname_r}/source/include/linux/fs.h" ]
then
    KDIR="/lib/modules/${uname_r}/source"
elif [ -e "/usr/src/linux-headers-${uname_r}/build/include/linux/fs.h" ]
then
    KDIR="/usr/src/linux-headers-${uname_r}/build"
else
    echo "Cannot infer kernel headers location"
    exit 1
fi

rm -f "${output}"

cat <<EOF >"${output}"
/* Autogenerated by kernel/config.sh - do not edit
 */

#ifndef _MHVTL_KERNEL_CONFIG_H
#define _MHVTL_KERNEL_CONFIG_H


EOF

for sym in ${!syms[@]}
do
    grep -q "${sym}" "${KDIR}/include/linux/${syms[$sym]}"
    if [ $? -eq 0 ]
    then
        printf '#define HAVE_%s\n' "$( echo "${sym}" | tr [:lower:] [:upper:] )" >> "${output}"
    else
        printf '#undef HAVE_%s\n' "$( echo "${sym}" | tr [:lower:] [:upper:] )" >> "${output}"
    fi
done

printf '\n\n#endif /* _MHVTL_KERNEL_CONFIG_H */\n' >> "${output}"
